<!DOCTYPE html>
<html lang="jp">
  <head>
    <meta charset="utf-8">
    <title>自費サービス入力</title>
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <link rel="stylesheet" type="text/css" href="/css/bootstrap.css">
    
    <link rel="stylesheet" type="text/css" href="/css/theme.css">
    <link rel="stylesheet" href="/css/font.css">
    <link rel="stylesheet" href="/css/jquery-ui.css" />
    <script src="/js/jquery-1.7.2.min.js" type="text/javascript"></script>
    <script src="/js/jquery-ui.js"></script>
	<script src="/js/validateUtils.js"></script>
	<script src="/js/messageMaster.js"></script>
	<script src="/js/jquery.ui.datepicker-ja.js"></script>

	</script>
	<script>

	serviced=[
//           ###SERVICE###
		{"id":"%1","date":"%2","timefrom":"%3","timeto":"%4","koumoku":"%5","naiyou":"%6","tanitime":"%7","fee":"%8","tantousha":"%9","tanka":"%10","zeiritsu":"%11"},
//           ###SERVICE###
		];


        tanifee=[
//           ###TANIFEE###
                {"id":"%1","from":"%2","to":"%3","koumoku":"%4","time":"%5","min":"%6","fee":"%7"},
//           ###TANIFEE###
                ];


        servicekoumoku=[
//           ###SERVICEKOUMOKU###
                {"id":"%1","value":"%2","seigen":"%3"},
//           ###SERVICEKOUMOKU###
                ];

        servicenaiyou=[
//           ###SERVICENAIYOU###
                {"id":"%1","value":"%2"},
//           ###SERVICENAIYOU###
                ];

        tantousha=[
//           ###SERVICETANTOUSHA###
                {"id":"%1","name":"%2"},
//           ###SERVICETANTOUSHA###
                ];

        zeiritsu=[
//           ###ZEIRITSU###
                {"zeiritsu":"%1","from":"%2","to":"%3"},
//           ###ZEIRITSU###
                ];


        var dataArrServiceID = new Array();
	var dataArrServiceDate = new Array();
	var dataArrServiceTimeFrom = new Array();
	var dataArrServiceTimeTo = new Array();
	var dataArrServiceKoumoku = new Array();
	var dataArrServiceNaiyou = new Array();
	var dataArrServiceTaniTime = new Array();
	var dataArrServiceFee = new Array();
	var dataArrServiceTantousha = new Array();
	var dataArrServiceZeiritsu = new Array();
	var dataArrServiceFeeTanka = new Array();
	var index;

        var htmldata="";

	jQuery(function(){
		//施設リストプルダウンの「本社」を非表示
		var shisetsuList = $(".shisetsulist a").get();
		var shisetsuListLength = shisetsuList.length;
		for (var i=0; i<shisetsuList.length; i++) {
			var shisetsuListObj = $(shisetsuList).get(i);
			if ($(shisetsuListObj).text() == "本社") {
				$(shisetsuListObj).parent().css("display", "none");
				shisetsuListLength -= 1; 
			}
		}
		//施設リストプルダウンの中身が0個の場合、吹き出しを非表示
		if (shisetsuListLength == 0) {
			$("#shisetsuList_ul").css("display", "none");
		}
        // デフォルトのサービス提供日設定
        var TN=$('#TaishouNenGappi').val().substr(0,4);
        var TT=$('#TaishouNenGappi').val().substr(4,2);

        $.datepicker.setDefaults({
            minDate:new Date(TN,TT-1,1),
            maxDate:new Date(TN,TT,1-1),
                        changeYear:false,
                        changeMonth:false,
                        yearRange:"c-130:c+1",
                        dateFormat: 'yy/mm/dd',
                dayNamesShort: ['日','月','火','水','木','金','土'],
            dayNamesMin: ['日','月','火','水','木','金','土']
        });
        $('#ServiceDate').datepicker();
        for(var n in servicenaiyou) {
            $('#slServiceNaiyou').append('<option value="'+servicenaiyou[n].id+'">'+servicenaiyou[n].value+'</option>');
        }

        for(var t in tantousha) {
            $('#ServiceTantousha').append('<option value="'+tantousha[t].id+'">'+tantousha[t].name+'</option>');
        }
        $('#ServiceTantousha').val('###USERID###');

        var lefttime=0;
        var limittime=240;

        if(serviced.length>0) {
		for (var b in serviced) {
                   htmldata="";  
                   ServiceDate=serviced[b].date;
                   ServiceFrom=serviced[b].timefrom;
                   ServiceTo=serviced[b].timeto;
                   ServiceKoumoku=serviced[b].koumoku;
                   dispServiceKoumoku="";
                   dispServiceTantousha="";
                   for (var k in servicekoumoku) {
                      if(ServiceKoumoku==servicekoumoku[k].id) {
                          dispServiceKoumoku=servicekoumoku[k].value;
                          break;
                      }
                   }
                   ServiceNaiyou=serviced[b].naiyou;
                   ServiceTaniTime=serviced[b].tanitime;
                   ServiceFee=serviced[b].fee;
                   ServiceTantousha=serviced[b].tantousha;
                   dispTantousha="";
                   for (var t in tantousha) {
                      if(ServiceTantousha==tantousha[t].id) {
                          dispServiceTantousha=tantousha[t].name;
                          break;
                      }
                   }
                   htmldata=htmldata+'<tr class="jihilist"><td style=" border:#bbbbbb solid 1px;">'+ServiceDate+'</td>';
                   htmldata=htmldata+'<td style=" border:#bbbbbb solid 1px;">'+ServiceFrom+'～'+ServiceTo+'</td>';
                   htmldata=htmldata+'<td style=" border:#bbbbbb solid 1px;">'+dispServiceKoumoku+'</td>';
                   htmldata=htmldata+'<td style=" border:#bbbbbb solid 1px;">'+ServiceNaiyou+'</td>';
                   htmldata=htmldata+'<td style=" border:#bbbbbb solid 1px;">'+ServiceTaniTime+'</td>';
                   htmldata=htmldata+'<td style=" border:#bbbbbb solid 1px;">'+ServiceFee+'</td>';
                   htmldata=htmldata+'<td style=" border:#bbbbbb solid 1px;">'+dispServiceTantousha+'</td></tr>';
                   $("#ServiceIchiran").append(htmldata);
                   dataArrServiceID.push(serviced[b].id);
                   dataArrServiceDate.push(serviced[b].date);
	           dataArrServiceTimeFrom.push(serviced[b].timefrom);
	           dataArrServiceTimeTo.push(serviced[b].timeto);
	           dataArrServiceKoumoku.push(serviced[b].koumoku);
	           dataArrServiceNaiyou.push(serviced[b].naiyou);
	           dataArrServiceTaniTime.push(serviced[b].tanitime);
	           dataArrServiceFee.push(serviced[b].fee);
	           dataArrServiceTantousha.push(serviced[b].tantousha);
	           dataArrServiceZeiritsu.push(serviced[b].zeiritsu);
	           dataArrServiceFeeTanka.push(serviced[b].tanka);
                   if(dispServiceKoumoku.match(/スタンダード/)){
                       if(dispServiceKoumoku.match(/追加/)){
                       } else {
                           lefttime=lefttime+parseInt(serviced[b].tanitime);
                       }
                   }
                   if(dispServiceKoumoku.match(/ケアプラス/)){
                       if(dispServiceKoumoku.match(/追加/)){
                       } else {
                           lefttime=lefttime+parseInt(serviced[b].tanitime);
                       }
                   }
                   if(dispServiceKoumoku.match(/ＶＩＰ/)){
                       if(dispServiceKoumoku.match(/追加/)){
                       } else {
                           lefttime=lefttime+parseInt(serviced[b].tanitime);
                       }
                   }
                 }
                $('#servicelefttime').text(limittime-lefttime);

        }

        ServiceKoumokuControl();

        function ServiceKoumokuControl() {
           selectedServiceKoumoku=$('#ServiceKoumoku').val();
           $('#ServiceKoumoku').empty();
           $('#ServiceKoumoku').append('<option value=""></option>');
           for(var k in servicekoumoku) {
               if(lefttime>=limittime) {
                  if(servicekoumoku[k].seigen=="n") {
                     $('#ServiceKoumoku').append('<option value="'+servicekoumoku[k].id+'">'+servicekoumoku[k].value+'</option>');
                  }
               } else {
                  $('#ServiceKoumoku').append('<option value="'+servicekoumoku[k].id+'">'+servicekoumoku[k].value+'</option>');
               }
           }
           $('#ServiceKoumoku').val(selectedServiceKoumoku);
        }

        // 対象年月を変更したときのサービス提供日設定
        $('#TaishouNenGappi').change(function(){
            TN=$('#TaishouNenGappi').val().substr(0,4);
            TT=$('#TaishouNenGappi').val().substr(4,2);
            $("#ServiceDate").datepicker("option","minDate",new Date(TN,TT-1,1));
            $("#ServiceDate").datepicker("option","maxDate",new Date(TN,TT,1-1));
        });



	    jQuery('.add').click(function(){
			//バリデーションチェック
			var message = "";
			message += validationCheck();
			if (message != "") {
				alert(message);
				return false;
			}
                   ServiceDate=$('#ServiceDate').val();
                   SeirekiServiceDate=ServiceDate.replace(/\//g,"");
                   ServiceZeiritsu=0;
                   for (z in zeiritsu) {
                       if(zeiritsu[z].from<=SeirekiServiceDate&&zeiritsu[z].to>SeirekiServiceDate) {
                           ServiceZeiritsu=zeiritsu[z].zeiritsu;
                           break;
                       }
                   }
                   ServiceFrom=$('#ServiceTimeFrom').val();
                   ServiceTo=$('#ServiceTimeTo').val();
                   ServiceFromVal=ServiceFrom.split(':');
                   ServiceToVal=ServiceTo.split(':');
                   ServiceTaniTimeNicchu=0;
                   ServiceTaniTimeYakan=0;
                   if(ServiceFromVal[0]>='08'&&ServiceToVal[0]<'18') {
                       ServiceFromMinute=parseInt(ServiceFromVal[0])*60+parseInt(ServiceFromVal[1]);
                       ServiceToMinute=parseInt(ServiceToVal[0])*60+parseInt(ServiceToVal[1]);
                       ServiceTaniTimeNicchu=ServiceToMinute-ServiceFromMinute;
                   } else if (ServiceFromVal[0]>='08'&&ServiceFromVal[0]<'18'&&ServiceToVal[0]>='18') {
                       ServiceFromMinute=parseInt(ServiceFromVal[0])*60+parseInt(ServiceFromVal[1]);
                       ServiceToMinute=18*60;
                       ServiceTaniTimeNicchu=ServiceToMinute-ServiceFromMinute;
                       ServiceFromMinute=18*60;
                       ServiceToMinute=parseInt(ServiceToVal[0])*60+parseInt(ServiceToVal[1]);
                       ServiceTaniTimeYakan=ServiceToMinute-ServiceFromMinute;
                   } else if (ServiceFromVal[0]>='18' || ServiceToVal[0]<'08') {
                       ServiceFromMinute=parseInt(ServiceFromVal[0])*60+parseInt(ServiceFromVal[1]);
                       ServiceToMinute=parseInt(ServiceToVal[0])*60+parseInt(ServiceToVal[1]);
                       ServiceTaniTimeYakan=ServiceToMinute-ServiceFromMinute;                       
                   } else if (ServiceFromVal[0]<'08'&&ServiceToVal[0]<'18'&&ServiceToVal[0]>='08') {
                       ServiceFromMinute=parseInt(ServiceFromVal[0])*60+parseInt(ServiceFromVal[1]);
                       ServiceToMinute=8*60;
                       ServiceTaniTimeYakan=ServiceToMinute-ServiceFromMinute;
                       ServiceFromMinute=8*60;
                       ServiceToMinute=parseInt(ServiceToVal[0])*60+parseInt(ServiceToVal[1]);
                       ServiceTaniTimeNicchu=ServiceToMinute-ServiceFromMinute;
                   } else if (ServiceFromVal[0]<'08'&&ServiceToVal[0]>='18') {
                       ServiceFromMinute=parseInt(ServiceFromVal[0])*60+parseInt(ServiceFromVal[1]);
                       ServiceToMinute=8*60;
                       ServiceTaniTimeYakan1=ServiceToMinute-ServiceFromMinute;
                       ServiceFromMinute=8*60;
                       ServiceToMinute=18*60;
                       ServiceTaniTimeNicchu=ServiceToMinute-ServiceFromMinute;
                       ServiceFromMinute=18*60;
                       ServiceToMinute=parseInt(ServiceToVal[0])*60+parseInt(ServiceToVal[1]);
                       ServiceTaniTimeYakan2=ServiceToMinute-ServiceFromMinute;
                       ServiceTaniTimeYakan=ServiceTaniTimeYakan1+ServiceTaniTimeYakan2;
                   }
                       
                   ServiceTaniTime=ServiceTaniTimeNicchu+ServiceTaniTimeYakan; 
                   ServiceKoumoku=$('#ServiceKoumoku').val();
                   dispServiceKoumoku=$('#ServiceKoumoku option:selected').text();
                   ServiceNaiyou=$('#ServiceNaiyou').val();
                   if($('#shisetsu').val()=="1004") {
                       for(var t in tanifee) {
                         if(tanifee[t].id=="001"&&tanifee[t].koumoku==ServiceKoumoku) {
                           if(ServiceTaniTimeNicchu>0&&ServiceTaniTimeNicchu<tanifee[t].min) {
                               ServiceTaniTimeNicchu=tanifee[t].min;
                           }
                           ServiceTanka=Math.ceil(ServiceTaniTimeNicchu/tanifee[t].time)*tanifee[t].fee;
                           ServiceFeeNicchu=Math.floor(ServiceTanka+ServiceTanka*ServiceZeiritsu);
                           ServiceTankaNicchu=ServiceTanka;
                           break;
                         }
                       }
                       for(var t in tanifee) {
                         if(tanifee[t].id=="002"&&tanifee[t].koumoku==ServiceKoumoku) {
                           if(ServiceTaniTimeYakan>0&&ServiceTaniTimeYakan<tanifee[t].min) {
                               ServiceTaniTimeYakan=tanifee[t].min;
                           }
                           ServiceTanka=Math.ceil(ServiceTaniTimeYakan/tanifee[t].time)*tanifee[t].fee;
                           ServiceFeeYakan=Math.floor(ServiceTanka+ServiceTanka*ServiceZeiritsu);
                           ServiceTankaYakan=ServiceTanka;
                           break;
                         }
                       }
                       ServiceFee=ServiceFeeNicchu+ServiceFeeYakan;
                       ServiceTanka=ServiceTankaNicchu+ServiceTankaYakan;
                   } else {
                       for(var t in tanifee) {
                         if(tanifee[t].id=="001"&&tanifee[t].koumoku==ServiceKoumoku) {
                           if(ServiceTaniTimeNicchu>0&&ServiceTaniTimeNicchu<tanifee[t].min) {
                               ServiceTaniTimeNicchu=tanifee[t].min;
                           }
                           ServiceTanka=Math.ceil(ServiceTaniTimeNicchu/tanifee[t].time)*tanifee[t].fee;
                           ServiceFeeNicchu=Math.floor(ServiceTanka+ServiceTanka*ServiceZeiritsu);
                           ServiceTankaNicchu=ServiceTanka;
                           break;
                         }
                       }
                       for(var t in tanifee) {
                         if(tanifee[t].id=="002"&&tanifee[t].koumoku==ServiceKoumoku) {
                           if(ServiceTaniTimeYakan>0&&ServiceTaniTimeYakan<tanifee[t].min) {
                               ServiceTaniTimeYakan=tanifee[t].min;
                           }
                           ServiceTanka=Math.ceil(ServiceTaniTimeYakan/tanifee[t].time)*tanifee[t].fee;
                           ServiceFeeYakan=Math.floor(ServiceTanka+ServiceTanka*ServiceZeiritsu);
                           ServiceTankaYakan=ServiceTanka;
                           break;
                         }
                       }
                       ServiceFee=ServiceFeeNicchu+ServiceFeeYakan;
                       ServiceTanka=ServiceTankaNicchu+ServiceTankaYakan;
                   }
                   ServiceTantousha=$('#ServiceTantousha').val();

                   lefttime_before_calc=lefttime;

                   if(dispServiceKoumoku.match(/スタンダード/)){
                       if(dispServiceKoumoku.match(/追加/)){
                       } else {
                           lefttime=lefttime+parseInt(ServiceTaniTime);
                       }
                   }
                   if(dispServiceKoumoku.match(/ケアプラス/)){
                       if(dispServiceKoumoku.match(/追加/)){
                       } else {
                           lefttime=lefttime+parseInt(ServiceTaniTime);
                       }
                   }
                   if(dispServiceKoumoku.match(/ＶＩＰ/)){
                       if(dispServiceKoumoku.match(/追加/)){
                       } else {
                           lefttime=lefttime+parseInt(ServiceTaniTime);
                       }
                   }

                   dispServiceTantousha=$('#ServiceTantousha option:selected').text();
                   if(lefttime>limittime) {
                       alert('サービス提供可能時間を超えています');
                       lefttime=lefttime_before_calc;
                   } else {
                       data = '<tr class="jihilist">';
                       data = data+'<td style=" border:#bbbbbb solid 1px;">'+ServiceDate+'</td>';
                       data = data+'<td style=" border:#bbbbbb solid 1px;">'+ServiceFrom+'～'+ServiceTo+'</td>';
                       data = data+'<td style=" border:#bbbbbb solid 1px;">'+dispServiceKoumoku+'</td>';
                       data = data+'<td style=" border:#bbbbbb solid 1px;">'+ServiceNaiyou+'</td>';
                       data = data+'<td style=" border:#bbbbbb solid 1px;">'+ServiceTaniTime+'</td>';
                       data = data+'<td style=" border:#bbbbbb solid 1px;">'+ServiceFee+'</td>';
                       data = data+'<td style=" border:#bbbbbb solid 1px;">'+dispServiceTantousha+'</td>';
                       data = data+'</tr>';
                       jQuery('#ServiceIchiran').append(data);
                       dataArrServiceID.push('_');
                       dataArrServiceDate.push(ServiceDate);
                       dataArrServiceTimeFrom.push(ServiceFrom);
                       dataArrServiceTimeTo.push(ServiceTo);
                       dataArrServiceKoumoku.push(ServiceKoumoku);
                       if(ServiceNaiyou==""){
                          ServiceNaiyou='_';
                       }
                       dataArrServiceNaiyou.push(ServiceNaiyou);
                       dataArrServiceTaniTime.push(ServiceTaniTime);
                       dataArrServiceFee.push(ServiceFee);
                       dataArrServiceTantousha.push(ServiceTantousha);
                       dataArrServiceFeeTanka.push(ServiceTanka);
                       dataArrServiceZeiritsu.push(ServiceZeiritsu);
                       $('#servicelefttime').text(limittime-lefttime);
                   }
                   ServiceKoumokuControl();
	    });

	    jQuery('.mod').live("click", function(){
		if (index>-1) {
			//バリデーションチェック
			var message = "";
			message += validationCheck();
			if (message != "") {
				alert(message);
				return false;
			}
                   ServiceDate=$('#ServiceDate').val();
                   SeirekiServiceDate=ServiceDate.replace(/\//g,"");
                   ServiceZeiritsu=0;
                   for (z in zeiritsu) {
                       if(zeiritsu[z].from<=SeirekiServiceDate&&zeiritsu[z].to>SeirekiServiceDate) {
                           ServiceZeiritsu=zeiritsu[z].zeiritsu;
                           break;
                       }
                   }
                   ServiceFrom=$('#ServiceTimeFrom').val();
                   ServiceTo=$('#ServiceTimeTo').val();
                   ServiceFromVal=ServiceFrom.split(':');
                   ServiceToVal=ServiceTo.split(':');
                   ServiceTaniTimeNicchu=0;
                   ServiceTaniTimeYakan=0;
                   if(ServiceFromVal[0]>='08'&&ServiceToVal[0]<'18') {
                       ServiceFromMinute=parseInt(ServiceFromVal[0])*60+parseInt(ServiceFromVal[1]);
                       ServiceToMinute=parseInt(ServiceToVal[0])*60+parseInt(ServiceToVal[1]);
                       ServiceTaniTimeNicchu=ServiceToMinute-ServiceFromMinute;
                   } else if (ServiceFromVal[0]>='08'&&ServiceFromVal[0]<'18'&&ServiceToVal[0]>='18') {
                       ServiceFromMinute=parseInt(ServiceFromVal[0])*60+parseInt(ServiceFromVal[1]);
                       ServiceToMinute=18*60;
                       ServiceTaniTimeNicchu=ServiceToMinute-ServiceFromMinute;
                       ServiceFromMinute=18*60;
                       ServiceToMinute=parseInt(ServiceToVal[0])*60+parseInt(ServiceToVal[1]);
                       ServiceTaniTimeYakan=ServiceToMinute-ServiceFromMinute;
                   } else if (ServiceFromVal[0]>='18' || ServiceToVal[0]<'08') {
                       ServiceFromMinute=parseInt(ServiceFromVal[0])*60+parseInt(ServiceFromVal[1]);
                       ServiceToMinute=parseInt(ServiceToVal[0])*60+parseInt(ServiceToVal[1]);
                       ServiceTaniTimeYakan=ServiceToMinute-ServiceFromMinute;                       
                   } else if (ServiceFromVal[0]<'08'&&ServiceToVal[0]<'18'&&ServiceToVal[0]>='08') {
                       ServiceFromMinute=parseInt(ServiceFromVal[0])*60+parseInt(ServiceFromVal[1]);
                       ServiceToMinute=8*60;
                       ServiceTaniTimeYakan=ServiceToMinute-ServiceFromMinute;
                       ServiceFromMinute=8*60;
                       ServiceToMinute=parseInt(ServiceToVal[0])*60+parseInt(ServiceToVal[1]);
                       ServiceTaniTimeNicchu=ServiceToMinute-ServiceFromMinute;
                   } else if (ServiceFromVal[0]<'08'&&ServiceToVal[0]>='18') {
                       ServiceFromMinute=parseInt(ServiceFromVal[0])*60+parseInt(ServiceFromVal[1]);
                       ServiceToMinute=8*60;
                       ServiceTaniTimeYakan1=ServiceToMinute-ServiceFromMinute;
                       ServiceFromMinute=8*60;
                       ServiceToMinute=18*60;
                       ServiceTaniTimeNicchu=ServiceToMinute-ServiceFromMinute;
                       ServiceFromMinute=18*60;
                       ServiceToMinute=parseInt(ServiceToVal[0])*60+parseInt(ServiceToVal[1]);
                       ServiceTaniTimeYakan2=ServiceToMinute-ServiceFromMinute;
                       ServiceTaniTimeYakan=ServiceTaniTimeYakan1+ServiceTaniTimeYakan2;
                   }

                   ServiceTaniTime=ServiceTaniTimeNicchu+ServiceTaniTimeYakan; 
                   ServiceKoumoku=$('#ServiceKoumoku').val();
                   dispServiceKoumoku=$('#ServiceKoumoku option:selected').text();
                   ServiceNaiyou=$('#ServiceNaiyou').val();
                   if($('#shisetsu').val()=="1004") {
                       for(var t in tanifee) {
                         if(tanifee[t].id=="001"&&tanifee[t].koumoku==ServiceKoumoku) {
                           if(ServiceTaniTimeNicchu>0&&ServiceTaniTimeNicchu<tanifee[t].min) {
                               ServiceTaniTimeNicchu=tanifee[t].min;
                           }
                           ServiceTanka=Math.ceil(ServiceTaniTimeNicchu/tanifee[t].time)*tanifee[t].fee;
                           ServiceFeeNicchu=Math.floor(ServiceTanka+ServiceTanka*ServiceZeiritsu);
                           ServiceTankaNicchu=ServiceTanka;
                           break;
                         }
                       }
                       for(var t in tanifee) {
                         if(tanifee[t].id=="002"&&tanifee[t].koumoku==ServiceKoumoku) {
                           if(ServiceTaniTimeYakan>0&&ServiceTaniTimeYakan<tanifee[t].min) {
                               ServiceTaniTimeYakan=tanifee[t].min;
                           }
                           ServiceTanka=Math.ceil(ServiceTaniTimeYakan/tanifee[t].time)*tanifee[t].fee;
                           ServiceFeeYakan=Math.floor(ServiceTanka+ServiceTanka*ServiceZeiritsu);
                           ServiceTankaYakan=ServiceTanka;
                           break;
                         }
                       }
                       ServiceFee=ServiceFeeNicchu+ServiceFeeYakan;
                       ServiceTanka=ServiceTankaNicchu+ServiceTankaYakan;
                   } else {
                      for(var t in tanifee) {
                         if(tanifee[t].id=="001"&&tanifee[t].koumoku==ServiceKoumoku) {
                           if(ServiceTaniTimeNicchu>0&&ServiceTaniTimeNicchu<tanifee[t].min) {
                               ServiceTaniTimeNicchu=tanifee[t].min;
                           }
                           ServiceTanka=Math.ceil(ServiceTaniTimeNicchu/tanifee[t].time)*tanifee[t].fee;
                           ServiceFeeNicchu=Math.floor(ServiceTanka+ServiceTanka*ServiceZeiritsu);
                           ServiceTankaNicchu=ServiceTanka;
                           break;
                         }
                      }
                      for(var t in tanifee) {
                         if(tanifee[t].id=="002"&&tanifee[t].koumoku==ServiceKoumoku) {
                           if(ServiceTaniTimeYakan>0&&ServiceTaniTimeYakan<tanifee[t].min) {
                               ServiceTaniTimeYakan=tanifee[t].min;
                           }
                           ServiceTanka=Math.ceil(ServiceTaniTimeYakan/tanifee[t].time)*tanifee[t].fee;
                           ServiceFeeYakan=Math.floor(ServiceTanka+ServiceTanka*ServiceZeiritsu);
                           ServiceTankaYakan=ServiceTanka;
                           break;
                         }
                       }
                       ServiceFee=ServiceFeeNicchu+ServiceFeeYakan;
                       ServiceTanka=ServiceTankaNicchu+ServiceTankaYakan;
                   }
                   ServiceTantousha=$('#ServiceTantousha').val();;
                   dispServiceTantousha=$('#ServiceTantousha option:selected').text();
                   beforeServiceKoumoku=jQuery('#ServiceIchiran tr').eq(index).children().eq(2).text();
                   beforeServiceTaniTime=jQuery('#ServiceIchiran tr').eq(index).children().eq(4).text();

                   lefttime_before_calc=lefttime;

                   if(dispServiceKoumoku.match(/スタンダード/)){
                       if(beforeServiceKoumoku.match(/スタンダード/)) {
                          if(beforeServiceKoumoku.match(/追加/)) {
                          } else {
                             lefttime=lefttime-beforeServiceTaniTime;
                          }
                       }
                       if(dispServiceKoumoku.match(/追加/)){
                       } else {
                          lefttime=lefttime+parseInt(ServiceTaniTime);
                       }
                   }
                   if(dispServiceKoumoku.match(/ケアプラス/)){
                       if(beforeServiceKoumoku.match(/ケアプラス/)) {
                          if(beforeServiceKoumoku.match(/追加/)) {
                          } else {
                             lefttime=lefttime-beforeServiceTaniTime;
                          }
                       }
                       if(dispServiceKoumoku.match(/追加/)){
                       } else {
                          lefttime=lefttime+parseInt(ServiceTaniTime);
                       }
                   }
                   if(dispServiceKoumoku.match(/ＶＩＰ/)){
                       if(beforeServiceKoumoku.match(/ＶＩＰ/)) {
                          if(beforeServiceKoumoku.match(/追加/)) {
                          } else {
                             lefttime=lefttime-beforeServiceTaniTime;
                          }
                       }
                       if(dispServiceKoumoku.match(/追加/)){
                       } else {
                          lefttime=lefttime+parseInt(ServiceTaniTime);
                       }
                   }
                   if(lefttime>limittime) {
                       alert('サービス提供可能時間を超えています');
                       lefttime=lefttime_before_calc;
                   } else {
                       jQuery('#ServiceIchiran tr').eq(index).children().eq(0).text(ServiceDate);
                       jQuery('#ServiceIchiran tr').eq(index).children().eq(1).text(ServiceFrom+"～"+ServiceTo);
                       jQuery('#ServiceIchiran tr').eq(index).children().eq(2).text(dispServiceKoumoku);
                       if(ServiceNaiyou==""){
                          ServiceNaiyou='_';
                       }
                       jQuery('#ServiceIchiran tr').eq(index).children().eq(3).text(ServiceNaiyou);
                       jQuery('#ServiceIchiran tr').eq(index).children().eq(4).text(ServiceTaniTime);
                       jQuery('#ServiceIchiran tr').eq(index).children().eq(5).text(ServiceFee);
                       jQuery('#ServiceIchiran tr').eq(index).children().eq(6).text(dispServiceTantousha);
                       modindex=index-1;
                       dataArrServiceDate.splice(modindex,1,ServiceDate);
                       dataArrServiceTimeFrom.splice(modindex,1,ServiceFrom);
                       dataArrServiceTimeTo.splice(modindex,1,ServiceTo);
                       dataArrServiceKoumoku.splice(modindex,1,ServiceKoumoku);
                       dataArrServiceNaiyou.splice(modindex,1,ServiceNaiyou);
                       dataArrServiceTaniTime.splice(modindex,1,ServiceTaniTime);
                       dataArrServiceFee.splice(modindex,1,ServiceFee);
                       dataArrServiceTantousha.splice(modindex,1,ServiceTantousha);
                       dataArrServiceFeeTanka.splice(modindex,1,ServiceTanka);
                       dataArrServiceZeiritsu.splice(modindex,1,ServiceZeiritsu);
                       $('#servicelefttime').text(limittime-lefttime);
                   }
		}
                ServiceKoumokuControl();
	    });

	    jQuery('.del').live("click", function(){
		if (index>-1) {
                        dispServiceKoumoku=$('#ServiceKoumoku option:selected').text();
                        jQuery('#ServiceIchiran tr').eq(index).remove();
    			delindex=index-1;
	                dataArrServiceID.splice(delindex,1);
	                dataArrServiceDate.splice(delindex,1);
	                dataArrServiceTimeFrom.splice(delindex,1);
	                dataArrServiceTimeTo.splice(delindex,1);
	                dataArrServiceKoumoku.splice(delindex,1);
	                dataArrServiceNaiyou.splice(delindex,1);
                        if(dispServiceKoumoku.match(/スタンダード/)){
                          if(dispServiceKoumoku.match(/追加/)) {
                          } else {
                             lefttime=lefttime-dataArrServiceTaniTime[delindex];
                          }
                        }
                        if(dispServiceKoumoku.match(/ケアプラス/)){
                          if(dispServiceKoumoku.match(/追加/)) {
                          } else {
                             lefttime=lefttime-dataArrServiceTaniTime[delindex];
                          }
                        }
                        if(dispServiceKoumoku.match(/ＶＩＰ/)){
                          if(dispServiceKoumoku.match(/追加/)) {
                          } else {
                             lefttime=lefttime-dataArrServiceTaniTime[delindex];
                          }
                        }
	                dataArrServiceTaniTime.splice(delindex,1);
	                dataArrServiceFee.splice(delindex,1);
	                dataArrServiceTantousha.splice(delindex,1);
	                dataArrServiceFeeTanka.splice(delindex,1);
	                dataArrServiceZeiritsu.splice(delindex,1);
	                index=-1;
                        $('#servicelefttime').text(limittime-lefttime);
		} 
                ServiceKoumokuControl();
                
	    });

	    jQuery('.clear').live("click",function(){
	    });
				
            $('#ServiceIchiran tbody tr').live("click", function(){
                $('#ServiceKoumoku').empty();
                $('#ServiceKoumoku').append('<option value=""></option>');
                for(var k in servicekoumoku) {
                   $('#ServiceKoumoku').append('<option value="'+servicekoumoku[k].id+'">'+servicekoumoku[k].value+'</option>');
                }               
                index=jQuery('#ServiceIchiran tr').index(this);
                arrindex=index-parseInt(1);
                var va1=jQuery('#ServiceIchiran tr').eq(index).children().eq(0).text();
    		jQuery('#ServiceDate').val(va1);
                var va2=jQuery('#ServiceIchiran tr').eq(index).children().eq(1).text();
                var stime=va2.split('～');
                jQuery('#ServiceTimeFrom').val(stime[0]);
                jQuery('#ServiceTimeTo').val(stime[1]);
    		jQuery('#ServiceKoumoku').val(dataArrServiceKoumoku[arrindex]);
                var va4=jQuery('#ServiceIchiran tr').eq(index).children().eq(3).text();
                if(va4=="_"){
                   va4="";
                }
                jQuery('#ServiceNaiyou').val(va4);
    		jQuery('#ServiceTantousha').val(dataArrServiceTantousha[arrindex]);
            });

            $('#Hyouji').click(function(){
                 jQuery('#hdTaishouNengappi').val($('#TaishouNenGappi').val());
                 $('#MODE').val('search');
                 document.frmJihiService.target="_self";
                 document.frmJihiService.method="POST";
                 document.frmJihiService.action="JIHI_SERVICE.CGI";
                 document.frmJihiService.submit();
            });

            $('#print').click(function(){
                 jQuery('#hdTaishouNengappi').val($('#TaishouNenGappi').val());
                 $('#MODE').val('print');
                 document.frmJihiService.target="printwindow";
                 document.frmJihiService.method="POST";
                 document.frmJihiService.action="JIHI_SERVICE.CGI";
                 document.frmJihiService.submit();
            });

	    $('#regist').click(function(){
                 $('#MODE').val('regist');
                 jQuery('#dataCsvServiceID').val(dataArrServiceID);
                 jQuery('#dataCsvServiceDate').val(dataArrServiceDate);
                 jQuery('#dataCsvServiceTimeFrom').val(dataArrServiceTimeFrom);
                 jQuery('#dataCsvServiceTimeTo').val(dataArrServiceTimeTo);
                 jQuery('#dataCsvServiceKoumoku').val(dataArrServiceKoumoku);
                 jQuery('#dataCsvServiceNaiyou').val(dataArrServiceNaiyou);
                 jQuery('#dataCsvServiceTaniTime').val(dataArrServiceTaniTime);
                 jQuery('#dataCsvServiceFee').val(dataArrServiceFee);
                 jQuery('#dataCsvServiceTantousha').val(dataArrServiceTantousha);
                 jQuery('#dataCsvServiceFeeTanka').val(dataArrServiceFeeTanka);
                 jQuery('#dataCsvServiceZeiritsu').val(dataArrServiceZeiritsu);
                 jQuery('#hdTaishouNengappi').val($('#TaishouNenGappi').val());
                 document.frmJihiService.target="_self";
                 document.frmJihiService.method="POST";
                 document.frmJihiService.action="JIHI_SERVICE.CGI";
                 document.frmJihiService.submit();
	    });

            $('#slServiceNaiyou').change(function(){
                 $('#ServiceNaiyou').val($('#slServiceNaiyou option:selected').text());
            });

            // メニュー上のボタン制御
            $("#home").click(function(){
               document.frmBack.submit();
            });

                $('.shisetsulist').live('mouseover',function(){
                   this.style.backgroundColor="lightgrey";
                });
                $('.shisetsulist').live('mouseout',function(){
                   this.style.backgroundColor="white";
                });
                $('.jihilist').live('click',function(){
                   $('.jihilist').each(function(i){
                      $('.jihilist').eq(i).css('background-color','white');
                   });
                   this.style.backgroundColor="lightgrey";
                });
	
	
	});
		function validationCheck() {
			var message = "";
			//サービス時間入れ子チェック
			message += validateTime();
			return message;
		}

		function validateTime() {
			var message = "";
			var separator = ":";
			var sTimes = $("input[type='time'][name*='ServiceTimeFrom']").get();
			var eTimes = $("input[type='time'][name*='ServiceTimeTo']").get();
			message = checkTime(sTimes, eTimes, separator, HOUMONKAIGO_Item.num6, HOUMONKAIGO_Item.num7);
			return message;
		}


	</script>

    <!-- Demo page code -->

    <style type="text/css">
        #line-chart {
            height:300px;
            width:800px;
            margin: 0px auto;
            margin-top: 1em;
        }
    </style>

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="lib/html5.js"></script>
    <![endif]-->

  </head>

  <!--[if lt IE 7 ]> <body class="ie ie6"> <![endif]-->
  <!--[if IE 7 ]> <body class="ie ie7 "> <![endif]-->
  <!--[if IE 8 ]> <body class="ie ie8 "> <![endif]-->
  <!--[if IE 9 ]> <body class="ie ie9 "> <![endif]-->
  <!--[if (gt IE 9)|!(IE)]><!--> 
  <!-- <![endif] -->
<div class="navbar">
  <div class="navbar-inner">
    <ul class="nav pull-right">
      <li id="fat-menu2">
        <a href="/E-LIFE/SYSTEM_SETTEI/cgi-bin/SIGN_IN.CGI" tabindex="-1">ログアウト</a>
      </li>
    </ul>
    <ul class="nav pull-right">
      <li class="dropdown" id="fat-menu">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
          <!-- ###USER__NAME### -->
          <i class="icon-user"></i>
          %1
          <!-- ###USER__NAME### -->
        </a>
      </li>
    </ul>
    <ul class="nav pull-right">
      <li class="dropdown on" id="fat-menu3">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#" tabindex="-1">
          ###SELECT_SHISETSU###
          <i class="icon-caret-down"></i>
        </a>
        <ul id="shisetsuList_ul" class="dropdown-menu" style="z-index:100">
          <!-- ###SHISETSU_TAISHOU### -->
          <li class="shisetsulist">
            <a href="javascript:Post('###USERID###','###PASSWORD###','%1','/E-LIFE/SYSTEM_SETTEI/cgi-bin/SIGN_IN.CGI')">%2</a>
          </li>
          <!-- ###SHISETSU_TAISHOU### -->
        </ul>
      </li>
    </ul>
      <font class="brand"><span style="position:relative; top:-4px; padding-left:6px;"><img src="/images/HSS_LOGO_COLOR2.png" alt="HSSマーク" width="290" height="26"></span><span style="position:relative; top:-2px;">開発環境</span></font>
  </div>
</div>
<div class="header">
  <h1 class="page-title">自費サービス入力</h1>
</div>
<div class="row-fluid">
  <table style="margin-left:2em;min-width:1024px;">
    <tr>
      <td style="width:25%;">
        利用者名：
        <font style="font-size:20px">
          <b>###RIYOUSHA###</b>
        </font>
      </td>
      <td style="width:25%;">
        対象年月:
        <select id="TaishouNenGappi" name="TaishouNenGappi">
          <!-- ###TAISHOUNENGAPPI### -->
          <option value="%1" %3>%2
          <!-- ###TAISHOUNENGAPPI### -->
        </select>
        <button id="Hyouji" name="Hyouji" style="vertical-align:center;">表示</button>
      </td>
      <td style="text-align:right;">
        <div class="btn-toolbar">
          <button class="btn btn-pink" id="regist" name="regist" style="display:###TOUROKUDISP###" type="button">
            <i class="icon-edit"></i>
            登録
          </button>
          <button class="btn btn-green" id="print" name="print" style="display:###PRINTDISP###" type="button">
            <i class="icon-print"></i>
            印刷
          </button>
          <button class="btn btn-move" id="home" name="home">
            <i class="icon-home"></i>
            戻る
          </button>
        </div>
      </td>
    </tr>
  </table>
</div>
<div class="container-fluid">
  <div class="well" style="min-width:1024px;">
    <div style="height:700px; overflow-y:auto">
      <form id="frmJihiService" name="frmJihiService">
        <input id="MODE" name="MODE" type="hidden" />
        <input id="USER_ID" name="USER_ID" type="hidden" value="###USERID###" />
        <input id="Riyoushaid" name="Riyoushaid" type="hidden" value="###RIYOUSHAID###" />
        <input name="hdKensakuShisetsu" type="hidden" value="###HDKENSAKUSHISETSU###" />
        <input id="userid" name="userid" type="hidden" value="###USERID###" />
        <input id="password" name="password" type="hidden" value="###PASSWORD###" />
        <input id="shisetsu" name="shisetsu" type="hidden" value="###SHISETSUID###" />
        <input id="hdTaishouNengappi" name="hdTaishouNengappi" type="hidden" value="###HDTAISHOUNENGAPPI###" />
        <div style="float:left; margin-right:2em; margin-top:2em;">
          <label for="ServiceDate">実施日</label>
          <input id="ServiceDate" name="ServiceDate" readonly="" style="background-color:lightyellow;width:100%" type="text" />
        </div>
        <div style="float:left; margin-right:2em; margin-top:2em;">
          <label>サービス時間</label>
          <input id="ServiceTimeFrom" name="ServiceTimeFrom" style="width:80px" type="time" />～
          <input id="ServiceTimeTo" name="ServiceTimeTo" style="width:80px" type="time" />
        </div>
        <div style="float:left; margin-right:2em; margin-top:2em;">
          <label for="ServiceKoumoku">サービス項目</label>
          <select id="ServiceKoumoku" name="ServiceKoumoku">
            <option value=""></option>
          </select>
        </div>
        <div style="float:left; margin-right:2em; margin-top:2em;">
          <label for="ServiceNaiyou">サービス内容</label>
          <input id="ServiceNaiyou" name="ServiceNaiyou" required="" type="text" />
          <select id="slServiceNaiyou" name="slServiceNaiyou">
            <option value=""></option>
          </select>
        </div>
        <div style="float:left; margin-right:2em; margin-top:2em;">
          <label for="ServiceTantousha">担当者</label>
          <select id="ServiceTantousha" name="ServiceTantousha"></select>
        </div>
        <div class="clearfix"></div>
        <p>
          <input class="add" type="button" value="追加" />
          <input class="mod" type="button" value="変更" />
          <input class="del" type="button" value="削除" />
        </p>
        <div class="clearfix"></div>
        <div style="margin-top:2em;display:###DISPCLAIRTYPE###">
           クレールサポートプランタイプ：<b>###CLAIRSERVICETYPE###</b>　　　サービス提供可能時間（分）：<p id="servicelefttime" style="display:inline"></p>
        </div>
        <table id="ServiceIchiran" style="margin-top:0px; border:#bbbbbb solid 2px;width:800px;">
          <thead>
            <tr>
              <th id="HeaderJissibi" style="width:120px; border:#bbbbbb solid 1px;background-color:#dddddd;">実施日</th>
              <th id="HeaderTime" style="width:150px;background-color:#dddddd; border:#bbbbbb solid 1px;">サービス時間</th>
              <th id="HeaderServiceKoumoku" style="width:120px; border:#bbbbbb solid 1px;background-color:#dddddd;">サービス項目</th>
              <th id="HeaderServiceNaiyou" style="width:200px; border:#bbbbbb solid 1px;background-color:#dddddd;">サービス内容</th>
              <th id="HeaderServiceTaniTime" style="width:150px; border:#bbbbbb solid 1px;background-color:#dddddd;">所要時間</th>
              <th id="HeaderServiceFee" style="width:150px; border:#bbbbbb solid 1px;background-color:#dddddd;">金額(円)消費税込</th>
              <th id="HeaderServiceTantousha" style="width:150px; border:#bbbbbb solid 1px;background-color:#dddddd;">担当者</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <input id="dataCsvServiceID" name="dataCsvServiceID" type="hidden" value="" />
        <input id="dataCsvServiceDate" name="dataCsvServiceDate" type="hidden" value="" />
        <input id="dataCsvServiceTimeFrom" name="dataCsvServiceTimeFrom" type="hidden" value="" />
        <input id="dataCsvServiceTimeTo" name="dataCsvServiceTimeTo" type="hidden" value="" />
        <input id="dataCsvServiceKoumoku" name="dataCsvServiceKoumoku" type="hidden" value="" />
        <input id="dataCsvServiceNaiyou" name="dataCsvServiceNaiyou" type="hidden" value="" />
        <input id="dataCsvServiceTaniTime" name="dataCsvServiceTaniTime" type="hidden" value="" />
        <input id="dataCsvServiceFee" name="dataCsvServiceFee" type="hidden" value="" />
        <input id="dataCsvServiceTantousha" name="dataCsvServiceTantousha" type="hidden" value="" />
        <input id="dataCsvServiceZeiritsu" name="dataCsvServiceZeiritsu" type="hidden" value="" />
        <input id="dataCsvServiceFeeTanka" name="dataCsvServiceFeeTanka" type="hidden" value="" />
      </form>
    </div>
  </div>
</div>

    <form id="frmBack" name="frmBack" action="HOUMONKAIGO_MENU.CGI" method="POST">
       <input type="hidden" name="Riyoushaid" value="###RIYOUSHAID###" >
       <input name="hdKensakuShisetsu" type="hidden" value="###HDKENSAKUSHISETSU###" />
       <input type="hidden" name="USER_ID" value="###USERID###" >
       <input type="hidden" name="MODE" value="init" >
       <input type="hidden" name="userid"  value="###USERID###" />
       <input type="hidden" name="password" value="###PASSWORD###" />
       <input type="hidden" name="shisetsu" value="###SHISETSUID###" />
    </form>


       <form action="" method="post" name="formlink">
           <input type="hidden" name="userid">
           <input type="hidden" name="password">
           <input type="hidden" name="cgi">
           <input type="hidden" name="shisetsu">
       </form>


    <script type="text/javascript">
        function Post(md,tx,shisetsu,url) {
            formlink.userid.value = md;
            formlink.password.value = tx;
            formlink.shisetsu.value = shisetsu;
            formlink.action=url;
            formlink.cgi.value = url;
            formlink.submit();
        }
    </script>

    <script src="/js/bootstrap.js"></script>
    <script type="text/javascript">
        $("[rel=tooltip]").tooltip();
        $(function() {
            $('.demo-cancel-click').click(function(){return false;});
        });
    </script>
    
  </body>
</html>


